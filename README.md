# Payment-Management-System

## About Sirius XM Radio Inc.
Sirius XM Holdings Inc. is an American broadcasting company headquartered in Midtown Manhattan, New York City that provides satellite radio and online radio services operating in the United States. It was formed by the 2008 merger of Sirius Satellite Radio and XM Satellite Radio, merging them into SiriusXM Radio. The company also has a 70% equity interest in Sirius XM Canada, an affiliate company that provides Sirius and XM service in Canada. On May 21, 2013, Sirius XM Holdings, Inc. was incorporated, and in November 2013, Sirius XM reorganized their corporate structure, which made Sirius XM Radio Inc. a direct, wholly owned subsidiary of Sirius XM Holdings, Inc.

## Why we updated the payment managment system 
### Convenient. 
The aggregate payment provides a series of application interface programs, which integrate multiple bank card payment methods into one interface, and is responsible for the docking with the bank in transaction settlement, making online shopping faster and more convenient. Third-party payment integrates the different payment interfaces of major back-end banks, and provides a unified access platform to facilitate merchants' access.
### Simple.
The requirements of the security level of the bank's commercial system, it has a poor payment experience, but with third-party payment platforms for payment operations are simpler and easier to accept. In the fierce competition of third-party payment, in order to compete for more users, a lot of optimizations have been made in terms of merchant access, user experience, and product ease of use to facilitate the payment experience of users and merchants.
### Less-cost.
third-party payment platforms reduce the cost of companies directly connecting to banks, thereby meeting the payment and receipt requirements of companies developing online businesses. The third-party payment platform simplifies the transfer of payment, thereby reducing the time required for transfer. The third-party payment platform avoids competition with service companies and only serves as an intermediate service layer. The diversity of third-party payment platforms provides customized settlement services for the market being served.
### Development
The third-party payment platform itself is attached to a large-scale portal website and relies on the credit of the bank with which it cooperates. Therefore, the third-party payment platform can better break through the credit problems in online transactions, which is conducive to the rapid development of e-commerce.

## What we did
Considering the impact of throughput, we changed the original synchronous programming method to asynchronous method. In this project, we used Java8 feature ExecutorService, and we also used Kafka, AWS, Jenkins and other technologies. They overall logic of the system is, 
letes the task execution result cached in Redis. Because oracle helps to provide a landing data source for subsequent fault tolerance, retry, data analysis.
### Payment process
1. The user purchases goods in the system and initiates a payment request;
2. The system transmits the payment order to the payment gateway through the B2C gateway collection interface;
3. The user chooses online banking payment and bank, and the payment platform forwards the order to the designated bank gateway interface;
4. After the user completes the payment, the bank processes the result and returns the processing result to the platform;
5. The payment platform receives the processing result, handles it and returns the result to the merchant;
6. The system receives the result returned by the payment company, handles it (change the order status) and informs the user.

The payment system will set up an "Available Balance" account and a "Pending Settlement" account for the merchant; when the system receives the payment success message returned by the bank, it will perform the landing process. On the one hand, the corresponding order status will be changed, and the merchant will be credited to the pending settlement account on the other hand. An amount; the amount will be transferred from the "account to be settled" ---> "Available Balance" account according to the settlement cycle.
### Refund process 
1. The user initiates a refund application on the merchant platform, and the system verifies the refund information and application;
2. The system logs in to the payment platform account or initiates a refund to the payment platform through the refund interface provided by the payment company;
3. The payment system will verify the refund information (whether the original order corresponding to the refund order was paid successfully. Is the refund amount less than or equal to the original order amount. Whether the system account balance is sufficient etc.)if the verification fails, it cannot refund;
4. The payment system deducts the amount from the system's available balance account, sends the refund order to the bank, and the bank completes the refund operation. Note: For the refund of orders collected by the gateway, each bank has different requirements. Some banks provide refund interfaces that require the original order to be valid for 90 or 180 days, and some banks do not provide refund interfaces; for overdue or non-support interface refunds The payment company completes the refund operation through the payment channel. 
5. For orders that have not been settled and are still in the "Pending Settlement" account, if there is a refund, the business process is similar to the above process, except that the payment is deducted from the pending settlement account.
### Settlement
In the settlement part, the system automatically settles the money to the merchant in accordance with the set settlement rules. 
1. Payment managemnt system helps finance fine-tune accounting and improves financial efficiency. 
2. Payment managemnt system automatically reconciles the accounts with the payment channels to ensure that the accounts are correct, and the problems can be located and dealt with in time under abnormal circumstances. 
3. Payment managemnt system can also carry out personalized tariff configuration or account period configuration for merchants, which is convenient and flexible. The value of the system is not only reflected in payment and settlement, but also in improving the efficiency of operation and management. 
4. The payment and settlement system can effectively help operations, finance, development and management personnel. For operators, the system can help deal with the operation of the platform, including various payment management, merchant and membership management, data statistics of marketing activities, etc., to comprehensively improve operational efficiency.
5. Payment managemnt system can assist in completing fund reconciliation, accounting processing, payment management, accounting error processing for financial personnel, , etc. Most of the work is automatically processed by the system, reducing manual processing and improving the efficiency of fund processing. 

A set of flexible and convenient configuration backends allows developers to quickly adjust the system to adapt to new businesses, and can facilitate system maintenance, such as channel access, rate configuration, account period adjustment, etc., to improve development efficiency. The system provides data on each link in the capital flow process, can calculate and analyze from various dimensions, form decision support for managers, thereby improving decision-making efficiency.
## Key points of Payment Management System
### Gateway
1. The payment gateway front is a module that connects to the business system and provides payment services for it. It is the integration front of all payment service interfaces and presents the interfaces provided by different payment channels to the business side in a unified way. In this way, the access party only needs to connect to the payment gateway, and the addition and adjustment of payment channels is transparent to the business party. The front-end design of the payment gateway has a direct impact on the stability, function, performance and other non-functional requirements of the entire payment system.
2. A large number of operations need to be completed in the payment gateway. In order to ensure performance, these operations are processed as asynchronous as possible. The front-end payment gateway should remain stable to minimize the impact of operations such as system restart on the business side. The payment gateway cannot avoid upgrading and restarting. This can be solved by the Nginx-based LBS (Load Balance System) gateway. LBS has two functions here: one is to achieve load balancing, and the other is to isolate the impact of payment gateway restart on calls. The payment gateway also adopts a distributed deployment of multiple machines. When restarting, each server is started one by one. When a server restarts, first cancel the registration from the LBS system, and then register to the LBS again after the restart is complete. This process is unaware of the caller.
3. In order to prevent the interface from being attacked, in terms of security, the business side must be required to access the interface through HTTPS and provide an anti-tampering mechanism. Anti-tampering is handled through interface parameter signatures. The mainstream signature is to sort the interface parameters according to the parameter name, then encrypt and hash them, referring to the signature specification of WeChat.
### Parameter verification
1. All payment operations need to perform parameter verification on the input to prevent the interface from being attacked.
2. Verify the validity of each field in the input parameters, such as user ID, merchant ID, price, return address and other parameters.
3. Verify account status. The status of the account of the transaction subject, counterparty, etc. is in a tradable state.
4. Order verification: If it involves a pre-order, you also need to verify the validity of the order number, and the order status is unpaid. In order to prevent the user from caching a certain URL address, it is also necessary to verify whether the order time and payment time exceed a predetermined interval.
5. Verify the signature. The signature is also to prevent the payment interface from being forged. Generally, the signature is to use the key distributed to the merchant to encrypt the string formed by the input parameters with MD5 Hash or RSA, and then submit it to the server as a parameter along with other parameters.
### Routing
According to the payment method selected by the user, the appropriate payment channel to complete the operation is determined. The payment method specified by the user is not necessarily the final payment channel. For example, users choose to use credit card to perform payment, but we did not realize the docking with card, but can use third-party payment, such as Paypel or UnionPay. How to choose a suitable payment channel is achieved through payment routing. Payment routing will comprehensively consider factors such as charges and channel availability to select the best solution.
### Asynchronous notification
If the caller has been blocking and waiting, it is easy to time out. The introduction of an asynchronous notification mechanism allows the caller to return as soon as possible in the main thread and obtain the payment result through the asynchronous thread. For the channel interface that obtains the payment result through asynchronous, it is also necessary to return the result to the caller in the asynchronous notification. Asynchronous notification requires the caller to provide a callback address, usually in the form of http or https. This is technically risky. If the call fails, it needs to be retried. The retry should not be too frequent, and the time interval between each retry needs to be gradually increased. In the asynchronous processing program, after the order changes its status according to the processing result, a message must also be sent to notify the relevant system.
